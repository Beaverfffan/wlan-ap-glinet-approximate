#!/bin/sh

tar_part_lookup() {
	part="$(fw_printenv -n cert_part)"
	if [ "$part" -eq 0 ]; then
		echo "$2"
		part=1
	else
		echo "$1"
		part=0
	fi
	fw_setenv cert_part $part
}

. /lib/functions.sh
case "$(board_name)" in
sonicfi,rap7110c-341x)
	cd /certificates
	tar cf /tmp/certs.tar .
	part=$(tar_part_lookup "0:BOOTCONFIG" "0:BOOTCONFIG1")
	mmc_dev=$(echo $(find_mmc_part $part) | sed 's/^.\{5\}//')
	dd if=/tmp/certs.tar of=/dev/$mmc_dev
	;;
udaya,a5-id2|\
yuncore,ax820)
	cd /certificates
	tar cf /tmp/certs.tar .
	part=$(tar_part_lookup "insta1" "insta2")
	mtd=$(find_mtd_index $part)
	dd if=/tmp/certs.tar of=/dev/mtdblock$mtd
	;;
sonicfi,rap6*)
	if [ "$(fw_printenv -n store_certs_disabled)" != "1" ]; then
		cd /certificates
		tar cf /tmp/certs.tar .
		part=$(tar_part_lookup "devinfo" "certificates")
		mtd=$(find_mtd_index $part)
		block_size=$(cat /sys/class/mtd/mtd$mtd/size)
		dd if=/tmp/certs.tar of=/tmp/certs_pad.tar bs=$block_size conv=sync
		mtd write /tmp/certs_pad.tar /dev/mtd$mtd
		rm -f /tmp/certs.tar /tmp/certs_pad.tar
	fi
	;;
esac
